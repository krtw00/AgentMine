<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AgentMine UI Prototype - Monitor (Split tree + table)</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="app">
      <div class="topbar">
        <div class="brand">AgentMine</div>
        <div class="pill"><span class="muted">Project</span> <strong>AgentMine</strong></div>
        <div class="pill"><span class="muted">SSE</span> <strong id="sseState">connected</strong></div>
        <div class="spacer"></div>
        <a class="btn" href="./monitor.html">Monitor A（Outline）</a>
        <a class="btn" href="./monitor-graph.html">Monitor C（Graph）</a>
        <a class="btn" href="./settings.html">Settings</a>
        <a class="btn" href="./agents.html">Agent Profiles</a>
      </div>

      <div class="main detailsHidden" id="main">
        <div class="left">
          <div class="section">
            <h2>Monitor B（Split tree + table）</h2>
            <div class="row">
              <input class="search" id="search" placeholder="検索: task / run / reason / agent_profile" autocomplete="off" />
              <label class="toggle">
                <input type="checkbox" id="includeDesc" checked />
                include descendants
              </label>
              <button class="btn primary" id="btnNewTask">+ Task</button>
            </div>
            <div class="row" style="margin-top: 8px">
              <span class="pill"><span class="muted">Selection</span> <strong id="selTask">All tasks</strong></span>
              <span class="pill"><span class="muted">Hint</span> <strong>click task</strong></span>
            </div>
            <div style="height: 10px"></div>
            <div class="overviewWrap">
              <div class="overviewHeader">
                <span>Overview（アクティビティ）</span>
                <span class="mono" id="rangeLabel">-</span>
              </div>
              <svg class="overviewSvg" id="overview" viewBox="0 0 1000 64" preserveAspectRatio="none"></svg>
            </div>
          </div>

          <div class="split">
            <div class="treePane" id="taskTree"></div>

            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th style="width: 100px">Status</th>
                    <th style="width: 320px">Task / Run</th>
                    <th style="width: 260px">Reasons</th>
                    <th style="width: 160px">Agent</th>
                    <th style="width: 110px">Started</th>
                    <th style="width: 90px">Duration</th>
                    <th style="width: 90px">DoD</th>
                    <th style="width: 90px">Violations</th>
                    <th class="waterfall">
                      Timeline
                      <div class="wfTicks" id="wfTicks"></div>
                    </th>
                  </tr>
                </thead>
                <tbody id="rows"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="right">
          <div class="section">
            <h2>Details</h2>
            <div class="row">
              <span class="pill"><span class="muted">Selected</span> <strong id="selLabel">none</strong></span>
              <span class="pill"><span class="muted">head_sha</span> <strong class="mono" id="selSha">-</strong></span>
              <div class="spacer"></div>
              <button class="btn" id="btnHideDetails">Hide</button>
            </div>
          </div>

          <div class="tabs" id="tabs"></div>
          <div class="panel" id="panel"></div>
        </div>
      </div>
    </div>

    <!-- Task drawer -->
    <div class="drawerBackdrop" id="drawerBackdrop"></div>
    <div class="drawer" id="drawer">
      <div class="drawerHeader">
        <div class="drawerTitle">Create Task</div>
        <div class="spacer"></div>
        <button class="btn" id="btnCloseDrawer">Close</button>
      </div>
      <div class="drawerBody">
        <div class="field">
          <label class="label">Title（必須）</label>
          <input class="input" value="New subtask" />
        </div>
        <div class="field">
          <label class="label">Description</label>
          <textarea class="textarea">分割タスクの説明を書く。</textarea>
        </div>

        <div class="field">
          <label class="label">write_scope（必須）</label>
          <div class="hint">B（ファイルツリー選択）で確定である。</div>
          <div class="hint">
            個人情報/秘密情報をAIから隠す場合は、write_scopeではなくexcludeを設定する。
            <a href="./settings.html" target="_blank" rel="noopener">Settings（scope.defaultExclude）</a> を参照。
          </div>
        </div>

        <div class="field">
          <label class="label">Tree selection（B）</label>
          <div class="tree" id="tree">
            <ul>
              <li>
                <label><input type="checkbox" data-glob="apps/web/**" checked /> apps/web/</label>
              </li>
              <li>
                <label><input type="checkbox" data-glob="apps/daemon/**" /> apps/daemon/</label>
              </li>
              <li>
                <label><input type="checkbox" data-glob="packages/**" checked /> packages/</label>
                <ul>
                  <li>
                    <label><input type="checkbox" data-glob="packages/core/**" /> packages/core/</label>
                  </li>
                  <li>
                    <label><input type="checkbox" data-glob="packages/ui/**" /> packages/ui/</label>
                  </li>
                </ul>
              </li>
              <li>
                <label><input type="checkbox" data-glob="docs/**" /> docs/</label>
              </li>
            </ul>
          </div>
        </div>

        <div class="field">
          <label class="label">プレビュー（最終write_scope）</label>
          <div class="chips" id="scopePreview"></div>
        </div>
      </div>
      <div class="drawerFooter">
        <button class="btn">Cancel</button>
        <button class="btn primary">Create</button>
      </div>
    </div>

    <script>
      const data = [
        {
          taskId: 10,
          taskTitle: "MVP UI",
          runs: [],
          children: [
            {
              taskId: 12,
              taskTitle: "Monitor UI (Run-first Network)",
              runs: [],
              children: [
                {
                  taskId: 121,
                  taskTitle: "Run table + filters",
                  runs: [
                    {
                      runId: 41,
                      status: "running",
                      reasons: ["merge_pending"],
                      agent: "coder",
                      started: "12:41",
                      durationSec: 132,
                      dod: "pending",
                      violations: 0,
                      headSha: "3f09a1b",
                    },
                    {
                      runId: 40,
                      status: "failed",
                      reasons: ["dod_failed"],
                      agent: "coder",
                      started: "12:10",
                      durationSec: 488,
                      dod: "failed",
                      violations: 0,
                      headSha: "1e2c9d4",
                    },
                  ],
                },
                {
                  taskId: 122,
                  taskTitle: "Details tabs + logs",
                  runs: [
                    {
                      runId: 43,
                      status: "completed",
                      reasons: ["merge_pending"],
                      agent: "coder",
                      started: "12:30",
                      durationSec: 210,
                      dod: "passed",
                      violations: 0,
                      headSha: "4aa91c0",
                    },
                  ],
                },
              ],
            },
            {
              taskId: 15,
              taskTitle: "Settings (exclude) UI",
              runs: [
                {
                  runId: 42,
                  status: "completed",
                  reasons: ["merge_pending"],
                  agent: "writer",
                  started: "12:50",
                  durationSec: 180,
                  dod: "passed",
                  violations: 0,
                  headSha: "7ab1c2d",
                },
              ],
            },
          ],
        },
        {
          taskId: 11,
          taskTitle: "Safety & Quality",
          runs: [],
          children: [
            {
              taskId: 13,
              taskTitle: "Fix scope violation handling",
              runs: [
                {
                  runId: 39,
                  status: "completed",
                  reasons: ["scope_violation_pending"],
                  agent: "generalist",
                  started: "11:22",
                  durationSec: 301,
                  dod: "passed",
                  violations: 2,
                  headSha: "9ad0b2c",
                },
              ],
            },
            {
              taskId: 14,
              taskTitle: "Define DoD checks",
              runs: [],
            },
          ],
        },
      ];

      const collapsed = new Set();
      let selectedTaskId = null; // null=All
      let selected = null;
      let activeTab = "Output";

      const elTaskTree = document.getElementById("taskTree");
      const elRows = document.getElementById("rows");
      const elSearch = document.getElementById("search");
      const elIncludeDesc = document.getElementById("includeDesc");
      const elSelTask = document.getElementById("selTask");

      const elTabs = document.getElementById("tabs");
      const elPanel = document.getElementById("panel");
      const elSel = document.getElementById("selLabel");
      const elSha = document.getElementById("selSha");
      const elMain = document.getElementById("main");
      const btnHideDetails = document.getElementById("btnHideDetails");
      const elOverview = document.getElementById("overview");
      const elRangeLabel = document.getElementById("rangeLabel");
      const elWfTicks = document.getElementById("wfTicks");

      function parseHHMMToDaySec(hhmm) {
        const [hh, mm] = String(hhmm ?? "00:00")
          .split(":")
          .map((x) => Number(x));
        return (hh || 0) * 3600 + (mm || 0) * 60;
      }

      function walkTasks(tasks, fn) {
        for (const t of tasks) {
          fn(t);
          for (const c of t.children ?? []) walkTasks([c], fn);
        }
      }

      function collectAllRuns(tasks) {
        const runs = [];
        walkTasks(tasks, (t) => runs.push(...(t.runs ?? [])));
        return runs;
      }

      const runsAll = collectAllRuns(data);
      const minAbsStart = Math.min(...runsAll.map((r) => parseHHMMToDaySec(r.started)), 0);
      const baseTimeSec = Math.floor(minAbsStart / 3600) * 3600;
      for (const r of runsAll) r.startedSec = parseHHMMToDaySec(r.started) - baseTimeSec;

      const minStart = Math.min(...runsAll.map((r) => r.startedSec), 0);
      const maxEnd = Math.max(...runsAll.map((r) => r.startedSec + r.durationSec), 1);
      const windowStart = Math.floor(minStart - 60);
      const windowEnd = Math.ceil(maxEnd + 60);
      const windowSpan = Math.max(1, windowEnd - windowStart);

      function fmtTime(sec) {
        const abs = baseTimeSec + sec;
        const hh = Math.floor(abs / 3600);
        const mm = Math.floor((abs % 3600) / 60);
        return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")}`;
      }

      function pct(sec) {
        return ((sec - windowStart) / windowSpan) * 100;
      }

      function collectRunsWithTask(tasks, out, includeDesc, rootTaskId) {
        const pick = (t) => {
          const allow =
            rootTaskId === null ||
            t.taskId === rootTaskId ||
            (includeDesc && isDescendant(t.taskId, rootTaskId));
          if (!allow) return;
          for (const r of t.runs ?? []) out.push({ task: t, run: r });
        };
        walkTasks(tasks, pick);
      }

      const parentById = new Map();
      function indexParents() {
        function indexNode(t, parentId) {
          parentById.set(t.taskId, parentId);
          for (const c of t.children ?? []) indexNode(c, t.taskId);
        }
        for (const t of data) indexNode(t, null);
      }
      indexParents();

      function isDescendant(nodeId, ancestorId) {
        if (ancestorId === null) return true;
        if (nodeId === ancestorId) return true;
        let cur = parentById.get(nodeId);
        while (cur != null) {
          if (cur === ancestorId) return true;
          cur = parentById.get(cur);
        }
        return false;
      }

      function countRuns(task) {
        let n = (task.runs ?? []).length;
        for (const c of task.children ?? []) n += countRuns(c);
        return n;
      }

      function indentPad(depth) {
        return `<span style="display:inline-block;width:${depth * 14}px"></span>`;
      }

      function badgeStatus(status) {
        if (status === "running") return '<span class="badge warn">running</span>';
        if (status === "failed") return '<span class="badge danger">failed</span>';
        if (status === "completed") return '<span class="badge ok">completed</span>';
        return `<span class="badge">${status}</span>`;
      }

      function badgeDoD(dod) {
        if (dod === "passed") return '<span class="badge ok">passed</span>';
        if (dod === "failed") return '<span class="badge danger">failed</span>';
        return '<span class="badge warn">pending</span>';
      }

      function renderOverview(items) {
        if (!elOverview) return;
        const height = 64;
        const width = 1000;

        const ticks = [];
        for (const p of [0, 0.25, 0.5, 0.75, 1]) {
          const sec = windowStart + windowSpan * p;
          ticks.push(`<span>${fmtTime(sec)}</span>`);
        }
        if (elWfTicks) elWfTicks.innerHTML = ticks.join("");
        if (elRangeLabel) elRangeLabel.textContent = `${fmtTime(windowStart)} - ${fmtTime(windowEnd)}`;

        const grid = [];
        for (const p of [0, 0.25, 0.5, 0.75, 1]) {
          const x = (width * p).toFixed(1);
          grid.push(
            `<line x1="${x}" y1="0" x2="${x}" y2="${height}" stroke="rgba(255,255,255,0.06)" stroke-width="1" />`
          );
        }

        const laneH = 6;
        const gap = 2;
        const topPad = 4;
        const maxLanes = Math.max(1, Math.floor((height - topPad * 2 + gap) / (laneH + gap)));
        const laneEnd = [];

        const sorted = [...(items ?? [])].sort((a, b) => a.run.startedSec - b.run.startedSec);
        const placed = [];
        for (const it of sorted) {
          let lane = -1;
          for (let i = 0; i < laneEnd.length; i++) {
            if (laneEnd[i] <= it.run.startedSec) {
              lane = i;
              break;
            }
          }
          if (lane === -1) {
            if (laneEnd.length < maxLanes) {
              lane = laneEnd.length;
              laneEnd.push(0);
            } else {
              let best = 0;
              for (let i = 1; i < laneEnd.length; i++) if (laneEnd[i] < laneEnd[best]) best = i;
              lane = best;
            }
          }
          laneEnd[lane] = Math.max(laneEnd[lane] ?? 0, it.run.startedSec + it.run.durationSec);
          placed.push({ lane, it });
        }

        const fillByStatus = (s) => {
          if (s === "running") return "rgba(204, 167, 0, 0.85)";
          if (s === "failed") return "rgba(241, 76, 76, 0.75)";
          if (s === "completed") return "rgba(137, 209, 133, 0.70)";
          return "rgba(14, 99, 156, 0.70)";
        };

        const bars = [];
        for (const { lane, it } of placed) {
          const left = pct(it.run.startedSec);
          const right = pct(it.run.startedSec + it.run.durationSec);
          const x = (width * left) / 100;
          const w = Math.max(1.2, (width * Math.max(0.2, right - left)) / 100);
          const y = topPad + lane * (laneH + gap);
          bars.push(
            `<rect data-run-id="${String(it.run.runId)}" x="${x.toFixed(1)}" y="${y.toFixed(
              1
            )}" width="${w.toFixed(1)}" height="${laneH}" fill="${fillByStatus(
              it.run.status
            )}" rx="2" ry="2" opacity="0.95"><title>Run #${it.run.runId} (${it.run.status})\\n${fmtTime(
              it.run.startedSec
            )} + ${it.run.durationSec}s</title></rect>`
          );
        }

        elOverview.innerHTML = [...grid, ...bars].join("");

        for (const r of elOverview.querySelectorAll("[data-run-id]")) {
          r.addEventListener("click", () => {
            const runId = Number(r.getAttribute("data-run-id"));
            const hit = (items ?? []).find((x) => x.run.runId === runId);
            if (!hit) return;
            const tr = document.querySelector(`tbody tr[data-kind="run"][data-run-id="${runId}"]`);
            if (tr) selectRun(hit.task, hit.run, tr);
          });
        }
      }

      function nodeMatches(t, q) {
        if (!q) return true;
        const s = q.toLowerCase();
        if (String(t.taskId).includes(s)) return true;
        if (t.taskTitle.toLowerCase().includes(s)) return true;
        for (const r of t.runs ?? []) {
          if (String(r.runId).includes(s)) return true;
          if (r.status.toLowerCase().includes(s)) return true;
          if (r.agent.toLowerCase().includes(s)) return true;
          if ((r.reasons ?? []).some((x) => x.toLowerCase().includes(s))) return true;
        }
        for (const c of t.children ?? []) if (nodeMatches(c, q)) return true;
        return false;
      }

      function renderTaskTree() {
        const q = elSearch.value.trim();
        elTaskTree.innerHTML = "";

        const all = document.createElement("div");
        all.className = "treeNode" + (selectedTaskId === null ? " selected" : "");
        all.innerHTML = `<span class="twisty">◎</span> All tasks <span class="treeMeta mono">${countAllRuns()} runs</span>`;
        all.addEventListener("click", () => {
          selectedTaskId = null;
          elSelTask.textContent = "All tasks";
          renderAll();
        });
        elTaskTree.appendChild(all);

        function renderNode(t, depth) {
          if (!nodeMatches(t, q)) return;
          const hasChildren = (t.children ?? []).length > 0;
          const isCollapsed = collapsed.has(t.taskId);
          const twisty = hasChildren ? (isCollapsed ? "▸" : "▾") : "•";

          const row = document.createElement("div");
          row.className = "treeNode" + (selectedTaskId === t.taskId ? " selected" : "");
          row.innerHTML = `${indentPad(depth)}<span class="twisty">${twisty}</span> Task #${t.taskId}: ${
            t.taskTitle
          } <span class="treeMeta">${countRuns(t)} runs</span>`;

          row.addEventListener("click", (ev) => {
            const target = ev.target;
            const clickedTwisty = target && target.classList && target.classList.contains("twisty");
            if (clickedTwisty && hasChildren) {
              if (collapsed.has(t.taskId)) collapsed.delete(t.taskId);
              else collapsed.add(t.taskId);
              renderTaskTree();
              return;
            }
            selectedTaskId = t.taskId;
            elSelTask.textContent = `Task #${t.taskId}`;
            renderAll();
          });

          elTaskTree.appendChild(row);

          if (hasChildren && !isCollapsed) {
            for (const c of t.children ?? []) renderNode(c, depth + 1);
          }
        }

        for (const t of data) renderNode(t, 0);
      }

      function countAllRuns() {
        let n = 0;
        walkTasks(data, (t) => (n += (t.runs ?? []).length));
        return n;
      }

      function runRow(task, run) {
        const left = pct(run.startedSec);
        const right = pct(run.startedSec + run.durationSec);
        const width = Math.max(0.8, right - left);

        const tr = document.createElement("tr");
        tr.dataset.kind = "run";
        tr.dataset.runId = String(run.runId);
        tr.dataset.taskId = String(task.taskId);
        tr.innerHTML = `
          <td>${badgeStatus(run.status)}</td>
          <td>Task #${task.taskId}: ${task.taskTitle} <span class="muted">/ Run #${run.runId}</span></td>
          <td>${run.reasons.map((x) => `<span class="chip">${x}</span>`).join(" ")}</td>
          <td><span class="chip">${run.agent}</span></td>
          <td class="muted">${fmtTime(run.startedSec)}</td>
          <td class="mono">${run.durationSec}s</td>
          <td>${badgeDoD(run.dod)}</td>
          <td class="mono">${run.violations}</td>
          <td>
            <div class="wf" title="${fmtTime(run.startedSec)} + ${run.durationSec}s">
              <div class="wfBar ${run.status}" style="left:${Math.max(0, left).toFixed(
                2
              )}%; width:${width.toFixed(2)}%"></div>
            </div>
          </td>
        `;
        tr.addEventListener("click", () => selectRun(task, run, tr));
        return tr;
      }

      function clearSelection() {
        for (const tr of document.querySelectorAll('tbody tr[data-kind="run"]')) tr.classList.remove("selected");
      }

      function selectRun(task, run, tr) {
        clearSelection();
        tr.classList.add("selected");
        selected = { task, run };
        elSel.textContent = `Task #${task.taskId} / Run #${run.runId}`;
        elSha.textContent = run.headSha;
        if (elMain) elMain.classList.remove("detailsHidden");
        renderPanel();
      }

      const tabs = [
        { id: "Output", label: "Output" },
        { id: "Meta", label: "Meta" },
        { id: "Timing", label: "Timing" },
        { id: "Checks", label: "Checks" },
        { id: "Violations", label: "Violations" },
        { id: "Git", label: "Git/Worktree" },
      ];

      function renderTabs() {
        elTabs.innerHTML = "";
        for (const t of tabs) {
          const div = document.createElement("div");
          div.className = "tab" + (t.id === activeTab ? " active" : "");
          div.textContent = t.label;
          div.addEventListener("click", () => {
            activeTab = t.id;
            renderTabs();
            renderPanel();
          });
          elTabs.appendChild(div);
        }
      }

      function renderPanel() {
        if (!selected) {
          elPanel.innerHTML = `<div class="muted">行を選択すると詳細が表示される。</div>`;
          return;
        }
        const { task, run } = selected;
        if (activeTab === "Meta") {
          elPanel.innerHTML = `
            <div class="kv">
              <div>task_id</div><div class="mono">${task.taskId}</div>
              <div>run_id</div><div class="mono">${run.runId}</div>
              <div>agent_profile</div><div>${run.agent}</div>
              <div>prompt</div><div class="mono">[prompt saved to run meta]</div>
              <div>scope_snapshot</div><div class="mono">write_scope + defaultExclude</div>
            </div>
          `;
          return;
        }
        if (activeTab === "Timing") {
          elPanel.innerHTML = `
            <div class="kv">
              <div>scope_apply</div><div class="mono">120ms</div>
              <div>runner_exec</div><div class="mono">${Math.max(1, run.durationSec - 2)}s</div>
              <div>post_check</div><div class="mono">1.2s</div>
              <div>dod_checks</div><div class="mono">3.8s</div>
            </div>
          `;
          return;
        }
        if (activeTab === "Checks") {
          elPanel.innerHTML = `
            <div class="kv">
              <div>dod.status</div><div>${badgeDoD(run.dod)}</div>
              <div>checks</div><div class="mono">lint: passed / test: pending</div>
              <div>output_ref</div><div class="mono">checks/run-${run.runId}/lint.log</div>
            </div>
          `;
          return;
        }
        if (activeTab === "Violations") {
          elPanel.innerHTML = `
            <div class="kv">
              <div>count</div><div class="mono">${run.violations}</div>
              <div>pending</div><div class="mono">${run.violations > 0 ? "2" : "0"}</div>
              <div>action</div><div><button class="btn">approve</button> <button class="btn">reject</button></div>
            </div>
          `;
          return;
        }
        if (activeTab === "Git") {
          elPanel.innerHTML = `
            <div class="kv">
              <div>head_sha</div><div class="mono">${run.headSha}</div>
              <div>worktree_dirty</div><div class="mono">${run.status === "running" ? "unknown" : "false"}</div>
              <div>branch</div><div class="mono">agentmine/task-${task.taskId}</div>
              <div>worktree_path</div><div class="mono">~/.agentmine/worktrees/{project_id}/task-${task.taskId}/</div>
            </div>
          `;
          return;
        }
        elPanel.innerHTML = `
          <div class="log">
[stdout] running step: analyze…\n
[stdout] changed files: docs/03-details/ui-mvp.md\n
[meta] prompt saved\n
[stderr] (none)\n
          </div>
        `;
      }

      function renderRunTable() {
        const q = elSearch.value.trim().toLowerCase();
        const includeDesc = elIncludeDesc.checked;
        elRows.innerHTML = "";

        const selectedLabel = selectedTaskId === null ? "All tasks" : `Task #${selectedTaskId}`;
        elSelTask.textContent = selectedLabel;

        const list = [];
        collectRunsWithTask(data, list, includeDesc, selectedTaskId);

        const matches = (text) => text.toLowerCase().includes(q);
        const filtered = list.filter(({ task, run }) => {
          if (!q) return true;
          return (
            matches(task.taskTitle) ||
            matches(String(task.taskId)) ||
            matches(String(run.runId)) ||
            matches(run.status) ||
            matches(run.agent) ||
            (run.reasons ?? []).some((x) => matches(x)) ||
            matches(run.dod) ||
            matches(run.headSha)
          );
        });

        renderOverview(filtered);

        if (filtered.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="muted">-</td>
            <td class="muted">(no runs in selection)</td>
            <td class="muted">-</td>
            <td class="muted">-</td>
            <td class="muted">-</td>
            <td class="muted">-</td>
            <td class="muted">pending</td>
            <td class="muted">0</td>
            <td><div class="wf"></div></td>
          `;
          elRows.appendChild(tr);
          return;
        }

        for (const item of filtered) elRows.appendChild(runRow(item.task, item.run));
      }

      function renderAll() {
        renderTaskTree();
        renderRunTable();
        renderTabs();
        renderPanel();
      }

      renderOverview();
      renderAll();
      elSearch.addEventListener("input", () => renderAll());
      elIncludeDesc.addEventListener("change", () => renderRunTable());

      if (btnHideDetails) {
        btnHideDetails.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          if (elMain) elMain.classList.add("detailsHidden");
        });
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          if (elMain) elMain.classList.add("detailsHidden");
        }
      });

      // Drawer
      const drawer = document.getElementById("drawer");
      const drawerBackdrop = document.getElementById("drawerBackdrop");
      const btnNewTask = document.getElementById("btnNewTask");
      const btnCloseDrawer = document.getElementById("btnCloseDrawer");

      function openDrawer() {
        drawerBackdrop.classList.add("open");
        drawer.classList.add("open");
        updateScopePreview();
      }
      function closeDrawer() {
        drawerBackdrop.classList.remove("open");
        drawer.classList.remove("open");
      }

      btnNewTask.addEventListener("click", openDrawer);
      btnCloseDrawer.addEventListener("click", closeDrawer);
      drawerBackdrop.addEventListener("click", closeDrawer);

      const scopePreview = document.getElementById("scopePreview");
      function escapeHtml(s) {
        return s.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;");
      }
      function readTreeGlobs(rootId) {
        const root = document.getElementById(rootId);
        if (!root) return [];
        const checked = Array.from(root.querySelectorAll('input[type="checkbox"]:checked'));
        return checked.map((x) => x.dataset.glob).filter(Boolean);
      }
      function updateScopePreview() {
        const scopes = Array.from(new Set(readTreeGlobs("tree")));
        scopePreview.innerHTML = scopes.map((s) => `<span class="chip">${escapeHtml(s)}</span>`).join("");
      }
      const treeRoot = document.getElementById("tree");
      if (treeRoot) treeRoot.addEventListener("change", updateScopePreview);
    </script>
  </body>
</html>
