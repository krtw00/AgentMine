FROM node:20-slim AS base
RUN corepack enable && corepack prepare pnpm@10.28.2 --activate

FROM base AS builder
WORKDIR /app
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY packages/shared/package.json ./packages/shared/
COPY packages/db/package.json ./packages/db/
COPY packages/daemon/package.json ./packages/daemon/
RUN pnpm install --frozen-lockfile

COPY tsconfig.base.json ./
COPY packages/shared ./packages/shared
COPY packages/db ./packages/db
COPY packages/daemon ./packages/daemon

RUN pnpm --filter @agentmine/shared build
RUN pnpm --filter @agentmine/db build
RUN pnpm --filter @agentmine/daemon build

# pnpm deployで自己完結型パッケージを作成
RUN pnpm --filter @agentmine/daemon deploy --prod --legacy /deploy

FROM base AS runner
WORKDIR /app
ENV NODE_ENV=production

# git（worktree用）をインストール
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*

# nodeユーザー(UID 1000)を利用（ホストUIDと一致、claude CLIはrootで実行不可）
RUN git config --global --add safe.directory '*'
# claude CLIはボリュームマウントで提供

COPY --from=builder /deploy ./
COPY --from=builder /app/packages/db/drizzle ./drizzle

RUN chown -R node:node /app && \
    apt-get update && apt-get install -y gosu && rm -rf /var/lib/apt/lists/*

EXPOSE 3001
COPY --chmod=755 entrypoint.sh /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
CMD ["node", "dist/index.js"]
