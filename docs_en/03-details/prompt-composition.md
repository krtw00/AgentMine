---
depends_on:
  - ./agent-profiles.md
  - ./task-decomposition.md
  - ./runner-adapter.md
  - ./scope-control.md
  - ./log-storage.md
  - ./observable-facts.md
tags: [details, prompt, composition, audit]
ai_summary: "Defines the convention for deterministically composing the final prompt for a run (inputs, structure, file path passing, retry/continue digest, audit storage)"
---

# Prompt Composition

> Status: Draft
> Last updated: 2026-02-01

This document defines the convention for composing the "final prompt" that is passed to the runner at run execution time.
The final prompt is subject to auditing and must be generated deterministically for reproducibility.

---

## Purpose

- Generate prompts independent of runner differences (e.g., notation differences like `@`).
- On retry/continue, present "what to fix next" from observable facts.
- Make it possible to trace "what was passed" before execution (store the prompt in the run log).

---

## Non-Goals

| Non-Goal                                      | Reason                                               |
| --------------------------------------------- | ---------------------------------------------------- |
| Embedding file contents                       | Increases prompt bloat and leakage risk              |
| Adopting runner-specific notation (e.g., `@`) | Increases runner differences and reduces portability |
| Treating AI self-reports as truth             | Status is determined by observable facts             |

---

## Generation Entity and Determinism

The final prompt is generated by a component within the Daemon (e.g., Prompt Composer).
Given the same inputs, the same final prompt must be generated.

| Item              | Policy                                            |
| ----------------- | ------------------------------------------------- |
| Generator         | Daemon                                            |
| Generation timing | Immediately before RunnerAdapter launch           |
| Determinism       | Same input produces same output                   |
| Audit             | Store the full final prompt in the run log (meta) |

---

## Inputs (MVP)

| Input Category        | Main Inputs                                                     | Source                    |
| --------------------- | --------------------------------------------------------------- | ------------------------- |
| Role                  | Agent Profile's `prompt_template`                               | DB                        |
| Task                  | task id/title/description/write_scope                           | DB                        |
| Constraints           | scope snapshot (synthesized write/exclude result)               | DB (runs.scope_snapshot)  |
| Execution environment | runner/model/config                                             | DB (agent_profiles, etc.) |
| Execution context     | worktree (current directory)                                    | Runtime environment       |
| Previous run facts    | exit code, check results, scope violations, changed files, etc. | DB + Git facts            |
| Additional input      | Human's additional input (continue only)                        | UI input                  |

Note:

- retry/continue creates a new run. The final prompt is also generated anew (see ADR-0005).

---

## File Path Passing (Runner-Independent)

Files are passed by "listing paths to reference" rather than "embedding content."
Paths are expressed as relative paths from the worktree root.

| Rule         | Content                                                                        |
| ------------ | ------------------------------------------------------------------------------ |
| Notation     | Do not use runner-specific notation (e.g., `@`)                                |
| Path format  | Relative path from worktree root                                               |
| Purpose      | Indicate entry points to read                                                  |
| Large volume | Instead of listing everything, prioritize entry files and directory guidelines |

Examples (path examples, not embedded content):

- `docs/00-index.md`
- `docs/03-details/data-model.md`

---

## Final Prompt Structure (MVP)

The final prompt is composed of the following sections in order.
Each section prioritizes a short, mechanically generatable format.

| Section               | Content                                                           |
| --------------------- | ----------------------------------------------------------------- |
| Role                  | Role and responsibilities (from Agent Profile)                    |
| Task                  | task id/title/description, key completion criteria                |
| Workspace             | The working directory is a worktree                               |
| Read First            | List of paths to reference (relative paths)                       |
| Constraints           | write/exclude, prohibited actions, items requiring approval       |
| Retry/Continue Digest | Summary of previous run's observable facts (only when applicable) |
| Output Format         | Expected output (change summary, commands to run, notes)          |

Note:

- DoD details (which commands to execute, etc.) are handled separately as DoD definitions.

---

## Retry/Continue Digest (Summary of Observable Facts)

The Digest consists solely of "observable facts," not "judgments."
The recommended summary items for the MVP are as follows.

| Summary Item     | Example                                      | Purpose                        |
| ---------------- | -------------------------------------------- | ------------------------------ |
| Run result       | exit code, termination reason                | Reproduce the failure          |
| Checks           | passed/failed, name of failed check          | DoD re-execution strategy      |
| Scope violations | count, representative paths, approval status | Avoid needs_review and explain |
| Changed files    | List of changed files (relative paths)       | Understand the scope of impact |

---

## Storage (Audit) and Events

The final prompt is stored as `meta` in the run log.
Separately from stdout/stderr, meta is used for tracking "execution prerequisites."

| Target           | Storage                 | Reason                       |
| ---------------- | ----------------------- | ---------------------------- |
| Final prompt     | run log (meta)          | Reproducibility and auditing |
| Execution output | run log (stdout/stderr) | Visualization and auditing   |

Notes:

- The storage method follows [Log Storage](./log-storage.md) (meta/references).
- UI notifications follow [Event Streaming](./event-stream.md) (run.output).

---

## Future Extensions (Out of Scope)

| Candidate Addition                  | Meaning                                                                   |
| ----------------------------------- | ------------------------------------------------------------------------- |
| Partial file content embedding      | Supported only for runners where `supports_prompt_file_inclusion` is true |
| Prompt diff display                 | Realized as diffs between meta logs                                       |
| Strict per-role template management | Handled through Agent Profile versioning                                  |

---

## Related Documents

- [Agent Profiles](./agent-profiles.md) - prompt_template and execution settings
- [RunnerAdapter](./runner-adapter.md) - Prompt passed to runner and auditing
- [Scope Control](./scope-control.md) - write/exclude and violation detection
- [Log Storage](./log-storage.md) - Storage as meta
- [Observable Facts](./observable-facts.md) - Basis for digest
